variables:
  DB_HOST: 127.0.0.1
  DB_DATABASE: preprodica
  DB_USERNAME: root
  DB_PASSWORD: Str0ngDBP@ssw0rd

stages:
  - test
  - deploy

unit_test:
  stage: test
  script:
    #
    - composer install
   #- php artisan key:generate
    - vendor/bin/phpunit
    
deploy_production:
  stage: deploy
  script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - echo ' eni chkoun ?:' && whoami
    - echo 'eni win' && pwd
   # - cd /var/www/html/test.com/SMS
    - php artisan down || true
    - git pull origin master
    - composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
    - cp .env.example .env
    - sudo php artisan key:generate --no-interaction  
#    - chmod -R a+w storage/ bootstrap/cache .env -S dhiaammar
  #  - php artisan cache:clear
   # - php artisan auth:clear-resets
    - php artisan up
    - echo "deploy done"
  environment:
    name: production
    url: http://192.168.161.132
  when: manual
  only:
    - master

